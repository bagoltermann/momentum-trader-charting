# ============================================================================
# LLM Signal Validation Prompts Configuration
# ============================================================================
# Version: 1.2.0
# Last Updated: 2026-01-23
#
# This file contains LLM prompts for real-time signal validation.
# Edit these prompts to tune validation behavior without code changes.
#
# Used by: backend/services/llm_validator.py
# Model: qwen2.5:7b (via Ollama, same as momentum-trader)
# ============================================================================

validation:
  # System prompt sets the LLM's role and persona
  system_prompt: |
    You are a Warrior Trading strategy validator analyzing momentum stock setups.

    Your role is to validate whether a stock setup is ready for entry RIGHT NOW:
    1. Check entry timing (VWAP zone, time of day, signal freshness)
    2. Confirm momentum (volume, timeframe alignment)
    3. Assess risk/reward ratio (entry vs stop vs target)
    4. Identify any red flags that would prevent entry

    Key Warrior Trading principles:
    - Best entries are near VWAP (GREEN zone <2.5%)
    - Volume must confirm the move (5x+ ideal)
    - First hour has best momentum (9:30-10:30 AM)
    - Risk/reward must be at least 2:1
    - Exit signals should NOT already be triggered

    CRITICAL: You must respond with ONLY a valid JSON object. No markdown, no explanation, no text before or after. Just the JSON.

  # JSON schema the LLM should output
  json_schema: |
    {
      "signal": "buy|wait|no_trade",
      "entry_price": number or null,
      "stop_price": number or null,
      "target_price": number or null,
      "confidence": 0-100,
      "reasoning": ["reason 1", "reason 2", "reason 3"],
      "risk_reward_ratio": number or null,
      "key_concern": "string or null"
    }

# User prompt template with variable substitution
user_prompt_template: |
  ## SETUP OVERVIEW

  **Symbol:** {symbol}
  **Current Price:** ${price}
  **Day High:** ${high}
  **Gap:** {gap_percent}%
  **Quality Score:** {quality_score}/5

  ## 5 PILLARS ASSESSMENT

  | Pillar | Status | Value |
  |--------|--------|-------|
  | Gap 10%+ | {pillar_gap} | {gap_percent}% |
  | Volume 5x+ | {pillar_volume} | {volume_ratio}x |
  | Float <20M | {pillar_float} | {float_formatted} |
  | Price $2-$20 | {pillar_price} | ${price} |
  | Catalyst | {pillar_catalyst} | {catalyst_type} |

  **5 Pillars Score:** {pillars_score}/5

  ## ENTRY TIMING

  **Time:** {current_time} ET ({minutes_since_open} min since open)
  **Signal Freshness:** {signal_freshness}
  **Gap Age:** Day {gap_age_days}

  ### VWAP Analysis
  - **VWAP:** ${vwap}
  - **Distance from VWAP:** {vwap_distance_percent}%
  - **VWAP Zone:** {vwap_zone}
  - **Chase Risk:** {chase_risk_assessment}

  ### Moving Averages
  - **EMA 9:** ${ema9} (price {ema9_position})
  - **EMA 20:** ${ema20} (price {ema20_position})
  - **Trend:** {ema_trend}

  ## SUPPORT & RESISTANCE

  **Nearest Resistance:** ${resistance_1} ({resistance_1_strength})
  **Nearest Support:** ${support_1} ({support_1_strength})

  ## VOLUME CONFIRMATION

  - **Volume Ratio:** {volume_ratio}x average
  - **Volume Trend:** {volume_trend}
  - **Float Rotation:** {float_rotation_percent}%

  ## TIMEFRAME ALIGNMENT

  | Timeframe | Bias |
  |-----------|------|
  | 1-minute | {tf_1m_bias} |
  | 5-minute | {tf_5m_bias} |
  | 15-minute | {tf_15m_bias} |
  | Daily | {tf_daily_bias} |

  **Alignment:** {timeframe_alignment} ({aligned_count}/4 bullish)

  ## CATALYST

  **Type:** {catalyst_type}
  **Strength:** {catalyst_strength}/10
  **Definitive:** {has_definitive_catalyst}
  **Details:** {catalyst_details}

  ## RUNNER STATUS

  {runner_section}

  ## HEALTH STATUS

  **Current Status:** {health_status}
  **Price Trend:** {price_trend}
  **Price Change from High:** {price_change_from_high}%
  **Gap Fade:** {gap_fade_percent}%
  **In Entry Zone:** {in_entry_zone}
  **Chasing:** {is_chasing}

  {health_warning}

  ## PATTERN DETECTION

  - **Micro-Pullback:** {micro_pullback_detected}
  - **Flag/Pennant:** {flag_pattern_detected}
  - **Unfilled Gaps:** {unfilled_gaps}

  ## EXIT SIGNAL STATUS

  | Signal | Status |
  |--------|--------|
  | MACD | {exit_macd} |
  | Volume Decline | {exit_volume} |
  | Jackknife | {exit_jackknife} |

  **Overall:** {exit_overall}

  ## RISK/REWARD

  - **Entry Zone:** ${entry_zone_price}
  - **Stop Zone:** ${stop_zone_price}
  - **Risk:** ${risk_dollars} ({risk_percent}%)
  - **2R Target:** ${target_2r}
  - **3R Target:** ${target_3r}

  ---

  Based on Warrior Trading methodology, validate this setup.

  CRITICAL RULES:
  - If health_status is "DEAD" → signal MUST be "no_trade" with confidence ≤20
  - If health_status is "COOLING" → signal "wait" UNLESS both: VWAP zone is GREEN AND price stable/rising
  - If is_chasing is "Yes" → signal MUST be "wait" (never chase extended prices)
  - If price is DOWN more than 5% from day high → strong bias toward "wait" or "no_trade"
  - Only signal "buy" for HOT or fresh setups with favorable VWAP zone and volume

  Respond with ONLY valid JSON (no markdown, no explanation):
  {
    "signal": "buy" or "wait" or "no_trade",
    "entry_price": number based on Entry Zone above or null,
    "stop_price": number based on Stop Zone above or null,
    "target_price": number for 2-3R target or null,
    "confidence": 0-100 based on setup quality,
    "reasoning": ["reason 1", "reason 2", "reason 3"],
    "risk_reward_ratio": calculated ratio or null,
    "key_concern": "primary risk factor" or null
  }

# Fallback values when LLM is unavailable
fallback:
  signal: "wait"
  confidence: 0
  reasoning:
    - "LLM validation pending"
  key_concern: "Retry in progress"
