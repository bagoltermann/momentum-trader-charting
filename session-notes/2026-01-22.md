# Session Notes - 2026-01-22

## Summary
Added LLM-powered signal validation feature using Ollama (qwen2.5:7b model) from momentum-trader.

## Features Implemented

### 1. LLM Validation Backend (`backend/services/llm_validator.py`)
- Reuses OllamaProvider from momentum-trader (no code duplication)
- Lazy imports to avoid crashes if momentum-trader not available
- Builds comprehensive context from watchlist, runners, quote, and candles
- Calculates 5 Pillars score, VWAP zone, EMA trend, time window
- 60-second cache to avoid repeated LLM calls
- Returns ValidationResult with signal, prices, confidence, reasoning

### 2. API Endpoints (`backend/api/routes.py`)
- `POST /api/validate/{symbol}` - Validate a stock setup
- `GET /api/validate/status` - Check if Ollama is available

### 3. Frontend Store (`src/renderer/store/validationStore.ts`)
- Zustand store for validation state
- `topCandidates` - Top 3 ranked by Warrior Trading criteria
- `topValidations` - Cached validation results (Record, not Map for Zustand)
- `refreshTopCandidates()` - Re-rank watchlist every 60s
- `validateTop3()` - Auto-validate top 3 candidates
- `validateManual()` - Manual validation for selected stock
- `checkLlmStatus()` - Poll Ollama availability

### 4. UI Components
- `Top3ValidationPanel.tsx` - Shows auto-validated top 3 candidates
- `ManualValidationPanel.tsx` - Shows result of manual validation
- Header "Validate" button - Triggers manual validation for selected chart

### 5. Launcher Updates (`Momentum Trader Charts.bat`)
- Auto-generates LLM config in charting.yaml
- Auto-starts Ollama if not running (via curl check + `ollama serve`)

## Issues Fixed

### App Startup Failures
- **Root cause**: Python import crashes at module load time
- **Fix 1**: Made OllamaProvider import lazy with try-except
- **Fix 2**: Changed `sys.path.insert(0, ...)` to `sys.path.append(...)` to avoid momentum-trader's `main.py` shadowing charting's `main.py`

### Missing Dependencies
- Added `requests` and `colorlog` to requirements.txt (needed by OllamaProvider)

### Zustand Map Reactivity
- Changed `Map<string, ValidationResult>` to `Record<string, ValidationResult>`
- Zustand doesn't trigger re-renders for Map mutations

### Ollama Not Available
- Singleton validator cached "not available" state at init
- Fixed `is_available()` to always check live status
- Added lazy provider initialization

## Files Changed

### New Files
- `backend/services/llm_validator.py` - LLM validation service
- `config/prompts/validation_prompt.yaml` - LLM prompt template
- `src/renderer/store/validationStore.ts` - Validation state management
- `src/renderer/components/panels/Top3ValidationPanel.tsx` - Top 3 UI
- `src/renderer/components/panels/ManualValidationPanel.tsx` - Manual validation UI

### Modified Files
- `backend/api/routes.py` - Added validate endpoints
- `backend/requirements.txt` - Added requests, colorlog
- `Momentum Trader Charts.bat` - Auto-start Ollama, generate LLM config
- `src/renderer/App.tsx` - Added validation hooks and intervals
- `src/renderer/components/layout/Header.tsx` - Added Validate button
- `src/renderer/components/panels/AnalysisPanels.tsx` - Added validation panels
- `src/renderer/styles/global.css` - Validation styles
- `STARTUP_GUIDE.md` - Documented LLM validation feature

## Key Learnings

### Python Path Management
When importing modules from another project:
- Use `sys.path.append()` not `insert(0, ...)` to avoid shadowing local modules
- Add both root (for `from src.utils`) and src (for `from llm.providers`)

### Zustand and Complex Types
- Zustand works poorly with Map/Set for reactivity
- Use plain objects (Record<K,V>) instead of Map<K,V>
- Spread objects to trigger updates: `{ ...existing }`

### Lazy Initialization Pattern
For optional dependencies:
```python
Provider = None
try:
    from external import Provider as _Provider
    Provider = _Provider
except ImportError:
    pass

def is_available():
    if Provider is None:
        return False
    # Check live status, don't cache at init
    return provider.is_available()
```

## Validation Signal Format
```json
{
  "signal": "buy" | "wait" | "no_trade",
  "entry_price": 2.80,
  "stop_price": 2.55,
  "target_price": 3.50,
  "confidence": 75,
  "reasoning": ["5 Pillars: 4.5/5", "VWAP zone: GREEN", "Volume confirms"],
  "risk_reward_ratio": 2.8,
  "key_concern": "Extended from VWAP",
  "timestamp": "2026-01-22T10:15:00",
  "symbol": "SLGB",
  "cached": false
}
```

## Next Steps (Deferred)
- Add Claude/Anthropic as alternative provider
- Historical pattern matching in prompts
- Validation history/logging for accuracy tracking
- UI toggle for LLM provider selection
