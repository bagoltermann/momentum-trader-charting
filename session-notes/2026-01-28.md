# Session Notes - 2026-01-28

## Status
Warrior Trading chart enhancements (Gap %, Volume, D1 High breakout alert) + 4 stability fixes. All changes implemented.

## Session Overview
1. Warrior Trading chart enhancements - Gap %, pre-market volume, D1 High breakout alert
2. Streaming relay disconnect fallback - Frontend falls back to REST polling when trader app disconnects
3. Zero candle data crash fix - Filter out placeholder candles with all-zero OHLC
4. httpx request hang band-aid fix - asyncio.wait_for() wrapper around API calls

## Work Completed

### Feature 1: Gap % + Volume Display (Warrior Trading Metrics)
**Files**: `src/renderer/components/charts/EnhancedChart.tsx`, `src/renderer/components/charts/MultiChartGrid.tsx`, `src/renderer/styles/global.css`
**Risk**: LOW

Added Warrior Trading metrics to chart header:
- **Gap % badge**: Shows Day 1 gap percentage from runner data
  - Green (strong): >= 20%
  - Yellow (moderate): 10-20%
  - Gray (weak): < 10%
- **Volume badge**: Shows total pre-market volume with ratio to average
  - Green (strong): >= 2x average
  - Yellow (moderate): 1-2x average
  - Gray (weak): < 1x average

**Props added to EnhancedChart**:
```typescript
gapPercent?: number        // Day 1 gap percentage from runner data
totalVolume?: number       // Sum of candle volumes (pre-market volume)
avgVolume?: number         // Average daily volume for ratio calculation
```

**Calculations in MultiChartGrid**:
```typescript
const primaryGapPercent = useMemo(() => {
  if (!primarySymbol) return undefined
  const runner = runners.find(r => r.symbol === primarySymbol)
  return runner?.original_gap_percent
}, [primarySymbol, runners])

const primaryTotalVolume = useMemo(() => {
  if (primaryCandles.length === 0) return undefined
  return primaryCandles.reduce((sum, c) => sum + (c.volume || 0), 0)
}, [primaryCandles])

const primaryAvgVolume = useMemo(() => {
  if (!primarySymbol) return undefined
  const runner = runners.find(r => r.symbol === primarySymbol)
  return runner?.day1_volume
}, [primarySymbol, runners])
```

### Feature 2: D1 High Breakout Alert
**File**: `src/renderer/components/charts/EnhancedChart.tsx`
**Risk**: LOW

Dynamic styling for D1 High price line based on proximity to current price:

| State | Distance | Line Style | Color | Width | Label |
|-------|----------|------------|-------|-------|-------|
| Normal | > 2% below | Dashed | #00E676 | 1 | D1 High |
| Approaching | 0-2% below | Solid | #FFD600 | 2 | D1 High (approaching) |
| Breakout | Above | Solid | #00E676 | 3 | D1 High (BREAKOUT) |

**Implementation**:
```typescript
if (zone.label === 'D1 High' && currentPrice && zone.price > 0) {
  const pctFromD1High = ((zone.price - currentPrice) / zone.price) * 100

  if (pctFromD1High < 0) {
    // BREAKOUT - price is ABOVE D1 High
    color = '#00E676'; lineWidth = 3; lineStyle = 0
    title = 'D1 High (BREAKOUT)'
  } else if (pctFromD1High < 2) {
    // APPROACHING - within 2% of D1 High
    color = '#FFD600'; lineWidth = 2; lineStyle = 0
    title = 'D1 High (approaching)'
  }
}
```

### Fix 1: Streaming Relay Disconnect Fallback
**Files**: `backend/services/quote_relay.py`, `src/renderer/hooks/useStreamingQuotes.ts`
**Risk**: LOW

**Problem**: When trader app crashes or is stopped while charting app is streaming, charts go blank. Frontend WebSocket to backend stays open (no error), but no data flows. Frontend thinks `streamingConnected = true`, so REST polling stays paused.

**Two-layer fix**:
1. **Backend relay status notifications**: QuoteRelay now sends `{type: 'status', connected: bool}` messages to all WebSocket clients when trader app connects/disconnects
2. **Frontend stale timeout**: If no quotes received for 60s, sets `streamingConnected = false` to trigger REST polling fallback

**Backend changes (quote_relay.py)**:
```python
def add_status_callback(self, cb):
    """Register callback for connection status changes"""
    self._status_callbacks.append(cb)
    # Immediately notify of current status
    cb({'type': 'status', 'connected': self._connected})

def _notify_status(self, connected: bool):
    """Notify all status callbacks of connection change"""
    for cb in self._status_callbacks:
        cb({'type': 'status', 'connected': connected})

def _on_connect(self):
    self._connected = True
    self._notify_status(True)

def _on_disconnect(self):
    self._connected = False
    self._notify_status(False)
```

### Fix 2: Zero Candle Data Crash
**File**: `src/renderer/hooks/useCandleData.ts`
**Risk**: LOW

**Problem**: Clicking on symbols during pre-market hours when Schwab API returns placeholder candles with OHLC = 0 causes chart to go blank or crash.

**Fix**: Filter out candles where OHLC are all zero during transform. Show "No trades yet" message instead of crashing.

```typescript
// Skip candles where OHLC are all zero (invalid/placeholder data)
if (c.open === 0 && c.high === 0 && c.low === 0 && c.close === 0) {
  debugLog(`[useCandleData] Skipping zero candle at ${c.timestamp}`)
  continue
}

// Handle case where all candles were filtered out
if (transformed.length === 0 && response.data.length > 0) {
  debugLog(`[useCandleData] All candles filtered (zeros) for ${symbol}`)
  if (mountedRef.current) {
    setError('No trades yet')
  }
  return
}
```

### Fix 3: httpx Request Hang (Band-Aid)
**File**: `backend/services/schwab_client.py`
**Risk**: LOW

**Problem**: Rapid clicking through watchlist stocks during pre-market causes backend to become unresponsive. httpx's internal timeout wasn't firing reliably.

**Band-aid fix**: Added `asyncio.wait_for()` wrapper around all `make_api_request()` calls with hard timeouts:
- 15s for price history requests
- 10s for quote requests

```python
response = await asyncio.wait_for(
    make_api_request(...),
    timeout=15.0  # Hard timeout
)
```

**Root cause unknown** - possible causes documented in troubleshooting guide:
1. Connection pool exhaustion
2. SSL handshake hang
3. DNS resolution hang
4. httpx Windows-specific bug
5. Schwab API rate limiting silently dropping connections

See `docs/session-notes/2026-01-27-chart-not-displaying-troubleshooting.md` failure mode #8 for full analysis.

## Testing Checklist
- [x] Gap % badge displays for runner stocks
- [x] Volume badge displays with ratio when avgVolume available
- [x] D1 High line changes style based on price proximity
- [x] Streaming disconnect triggers REST polling fallback within 60s
- [x] Zero candle data shows "No trades yet" instead of crash
- [x] Rapid symbol switching doesn't hang backend (timeouts fire)

## Files Modified

| File | Description |
|------|-------------|
| `src/renderer/components/charts/EnhancedChart.tsx` | Added gapPercent/volume props, badges in header, D1 High proximity logic |
| `src/renderer/components/charts/MultiChartGrid.tsx` | Calculate and pass gap%, volume, avgVolume to EnhancedChart |
| `src/renderer/styles/global.css` | Added gap-badge and volume-badge styles |
| `src/renderer/hooks/useCandleData.ts` | Zero candle filtering |
| `src/renderer/hooks/useStreamingQuotes.ts` | NEW - WebSocket client with stale detection |
| `backend/services/quote_relay.py` | Status callbacks for connect/disconnect events |
| `backend/services/schwab_client.py` | asyncio.wait_for() timeout wrappers |
| `docs/session-notes/2026-01-27-chart-not-displaying-troubleshooting.md` | Updated failure mode #8 with band-aid analysis |

## Key Takeaways
- **Pre-market data is sparse** - Many small-cap runner stocks have zero trades before market open. Schwab returns placeholder candles with all zeros. Filtering these is essential to prevent chart crashes.
- **asyncio.wait_for() is a valid defensive pattern** - Even when you trust a library's internal timeout, wrapping with `asyncio.wait_for()` provides a guaranteed hard cutoff. It's production-grade, not just a hack.
- **Streaming fallback needs multiple layers** - Backend status notifications handle immediate disconnect detection, but a stale timeout handles cases where the status message is missed (network glitch, etc.).
- **D1 High proximity is valuable** - Knowing when price is approaching the breakout level (within 2%) lets the trader prepare rather than react.

### Fix 4: Sync Watchlist Fetch Blocking Event Loop (ROOT CAUSE FOUND)
**Files**: `backend/services/file_watcher.py`, `backend/api/routes.py`
**Risk**: LOW

**Problem**: Backend hung after ~2 hours of operation. Log showed watchlist polls stopping (last entry was a successful watchlist fetch), then complete silence - no incomplete Schwab API requests.

**Root cause analysis**:
- The previous httpx hang theory was incorrect for this occurrence
- `file_watcher.py` used **synchronous httpx** (`httpx.Client`) to fetch watchlist from trader app
- Even with a 5s timeout, the sync call blocked the entire async event loop while waiting
- If trader app became slow (busy processing), the blocking call froze all other requests
- This explains why the log showed successful watchlist fetches then silence - the next watchlist fetch blocked forever

**Fix**:
1. Created `get_cached_watchlist_async()` wrapper using `asyncio.to_thread()`
2. Updated `/api/watchlist` route to use the async version
3. Kept original sync version for startup initialization

```python
async def get_cached_watchlist_async(refresh: bool = False) -> Optional[List[Dict]]:
    if refresh:
        if time_module.time() - _watchlist_cache_time > _WATCHLIST_CACHE_TTL:
            await asyncio.to_thread(fetch_watchlist_from_trader)
    with _cache_lock:
        return _cached_watchlist
```

### Fix 5: Missed Call Site in /validate Route
**Files**: `backend/api/routes.py`
**Risk**: LOW

**Problem**: After first fix, backend still hung immediately on first validation request. Log showed "POST /validate/OM started" then silence.

**Root cause**: The `/validate/{symbol}` route on line 180 also called `get_cached_watchlist()` but we only updated the `/api/watchlist` route. Since we changed the import to only include `get_cached_watchlist_async`, the old call raised a `NameError`.

**Fix**: Changed line 180 to use `await get_cached_watchlist_async()`.

## Next Steps
- Monitor for additional hang occurrences after this fix
- Consider audio alert for D1 High breakout (optional, could be annoying)
- Long-term stability test with streaming enabled

---

**Last Updated**: 2026-01-28
