# Session Notes - 2026-01-23

## Summary
Fixed LLM validation reliability issues: JSON parsing failures, tooltip UI improvements, backend stability.
**CRITICAL FIX**: LLM validator now health-aware - DEAD stocks get `no_trade` signal.
**CRITICAL FIX**: Fixed NoneType error preventing validation for stocks with null `llm_analysis`.

## Status
- **LLM Validation**: Health-aware! DEAD → no_trade, COOLING → wait (unless GREEN VWAP)
- **Top 3 Panel**: Tooltips now display upward, panel compacted to fit all 3 candidates
- **Backend**: Windows asyncio crash fixed (WindowsSelectorEventLoopPolicy)

---

## Session Overview

1. Fixed Windows asyncio backend crash (overnight issue)
2. Fixed runners being excluded from Top 3 candidates
3. Added tooltips to Top 3 candidates with Warrior Trading info
4. Fixed tooltip positioning (displays upward instead of down)
5. Compacted Top 3 panel height (all 3 visible without scrolling)
6. Investigated KUST validation failure (JSON parse error)
7. Added robust JSON extraction with detailed logging
8. Fixed DRCT NoneType validation error (`.get()` returning None instead of default)
9. Made LLM validator health-aware (DEAD → no_trade, COOLING → wait)
10. Fixed watchlist sync (RVYL missing) - fetch from trader API instead of file
11. Integrated real-time catalyst boost data from trader app v1.43.2
12. Added First Pullback pattern detection (v1.44.0 trader app pattern)

---

## Issues Fixed

### 1. Windows Asyncio Backend Crash

**Problem**: Backend crashed overnight with `AssertionError: _sockets is not None`

**Root Cause**: Windows ProactorEventLoop has issues with long-running HTTP servers

**Fix**: Added `WindowsSelectorEventLoopPolicy` at module level in `backend/main.py`:
```python
import platform
if platform.system() == 'Windows':
    asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
```

**File**: [backend/main.py](../backend/main.py)

---

### 2. Runners Excluded from Top 3

**Problem**: Multi-day runners (continuation plays) weren't appearing in Top 3 despite high quality scores

**Root Cause**: 5 Pillars calculation used today's gap % (near 0 for Day 2+) instead of original gap from Day 1

**Fix**: Updated `calculate5Pillars()` in `validationStore.ts`:
- For runners: Use `continuation_data.original_gap_percent` from Day 1
- For runners: Volume check uses `runner_quality_score >= 70` (pre-qualified)
- For runners: Catalyst check includes `continuation_data.original_catalyst`
- Lowered minimum pillars for runners from 4 to 3

**File**: [src/renderer/store/validationStore.ts](../src/renderer/store/validationStore.ts)

---

### 3. Top 3 Tooltip Feature

**Feature**: Hover over any Top 3 candidate to see critical Warrior Trading info

**Tooltip Contents**:
- Play type badge: "RUNNER (Day 2+)" or "FRESH GAP"
- 5 Pillars score, Quality score, Volume ratio, Gap %
- LLM Signal, Confidence %, Risk/Reward ratio
- Key concern (warning)
- Analysis reasoning (first 3 points)

**Files**:
- [Top3ValidationPanel.tsx](../src/renderer/components/panels/Top3ValidationPanel.tsx) - `CandidateTooltip` component
- [global.css](../src/renderer/styles/global.css) - Tooltip styling

---

### 4. Tooltip Positioning Fix

**Problem**: Tooltip displayed downward, going off bottom of page

**Fix**: Changed tooltip to anchor at bottom and grow upward:
```css
.candidate-tooltip {
  transform: translateY(-100%);  /* Grow upward from anchor point */
}
```

---

### 5. Top 3 Panel Height Fix

**Problem**: 3rd stock not visible without scrolling after tooltip changes

**Fix**: Compacted panel CSS:
- Reduced row padding from 8px to 5px
- Reduced gaps from 10px to 6-8px
- Reduced font sizes by 1-2px
- Made runner badge and signal badge smaller

---

### 6. JSON Parse Failures (KUST Validation)

**Problem**: KUST showed "Unable to Validate" in tooltip despite being in Top 3

**Error in logs**: `Failed to parse JSON: All repair attempts failed: line 1 column 1 (char 0)`

**Root Cause**: LLM returned empty or malformed JSON, and we couldn't see what it actually returned (logged at DEBUG level only)

**Fix**: Added robust JSON extraction layer in `llm_validator.py`:

1. **New `_extract_json_from_response()` method**:
   - Handles empty responses
   - Extracts JSON from markdown code blocks
   - Regex extraction of JSON object from surrounding text
   - Repairs trailing commas and single quotes
   - Logs when response contains "signal" but parsing still failed

2. **New `_call_llm_with_json_extraction()` method**:
   - First tries provider's built-in `complete_json()`
   - If that fails, calls `complete()` to get raw text
   - Attempts custom extraction on raw response
   - Logs raw response at WARNING level on failure (visible in logs!)
   - Returns `raw_response` for debugging

3. **Updated `validate_signal()` retry logic**:
   - Captures and logs last raw response when all retries fail
   - Better `[SYMBOL]` prefix formatting in logs

**File**: [backend/services/llm_validator.py](../backend/services/llm_validator.py)

---

## Files Modified

### Backend
| File | Changes |
|------|---------|
| `backend/main.py` | Added WindowsSelectorEventLoopPolicy for Windows stability; passes trader API URL to file_watcher |
| `backend/services/llm_validator.py` | Added `_extract_json_from_response()`, `_call_llm_with_json_extraction()`, `_build_realtime_regrade_context()`, `_build_first_pullback_context()`, health-aware context, NoneType fixes |
| `backend/services/file_watcher.py` | Watchlist now fetched from trader API instead of watchlist_state.json |
| `backend/api/routes.py` | `/watchlist` endpoint refreshes from trader API on each request |
| `config/prompts/validation_prompt.yaml` | v1.4.0: Added HEALTH STATUS, REAL-TIME CATALYST BOOST, FIRST PULLBACK sections, CRITICAL RULES |

### Frontend
| File | Changes |
|------|---------|
| `src/renderer/store/validationStore.ts` | Fixed 5 Pillars calculation for runners (use original gap/volume) |
| `src/renderer/components/panels/Top3ValidationPanel.tsx` | Added `CandidateTooltip` component, runner badge, error state messaging |
| `src/renderer/styles/global.css` | Tooltip styles, compacted Top 3 panel, upward-growing tooltip |

---

## Code Snippets

### JSON Extraction Logic (llm_validator.py:601-692)
```python
def _extract_json_from_response(self, raw_response: str, symbol: str) -> Optional[Dict]:
    """Extract and parse JSON from LLM response with robust error handling."""
    if not raw_response or not raw_response.strip():
        _logger.warning(f"[{symbol}] Empty response from LLM")
        return None

    content = raw_response.strip()

    # Remove markdown code blocks
    if '```json' in content:
        content = content.split('```json')[1].split('```')[0].strip()
    # ...

    # Try to extract JSON object from surrounding text
    match = re.search(r'\{[\s\S]*\}', content)
    if match:
        json_str = match.group(0)
        # Repair trailing commas and single quotes
        # ...
```

### 5 Pillars for Runners (validationStore.ts:84-110)
```typescript
function calculate5Pillars(stock: WatchlistItem) {
  const isRunner = stock.continuation_play === true

  // For runners, use original gap percent from Day 1
  const gapValue = isRunner
    ? (stock.continuation_data?.original_gap_percent || 0)
    : (stock.gap_percent || 0)
  const gap = gapValue >= 10

  // For runners, they had confirmed volume on Day 1
  const volume = isRunner
    ? (stock.runner_quality_score || 0) >= 70
    : (stock.volume_ratio || 0) >= 5
  // ...
}
```

---

## Testing Checklist

- [ ] Restart backend to pick up llm_validator.py changes
- [ ] Verify Top 3 panel shows all 3 candidates without scrolling
- [ ] Hover over candidate to see tooltip (should grow upward)
- [ ] Verify runners appear in Top 3 with proper gap % (original Day 1 value)
- [ ] Check backend logs for JSON extraction messages on validation failures
- [ ] Monitor for overnight stability (no asyncio crash)

---

## Key Takeaways

### 1. Windows Asyncio Event Loop
Windows ProactorEventLoop causes crashes with long-running HTTP servers. Use `WindowsSelectorEventLoopPolicy` instead.

### 2. Debug vs Warning Logging
When things fail intermittently, log at WARNING level so it shows up in normal output. DEBUG level is often too quiet.

### 3. JSON Extraction Layers
LLMs are unreliable with JSON output. Having multiple extraction attempts (provider's built-in + custom) improves reliability.

### 4. Prompt Changes Are Risky
Simplifying prompts to fix JSON issues can remove valuable trading analysis. Better to fix JSON parsing robustly while keeping rich prompts.

### 5. Runner vs Fresh Gap Logic
Day 2+ runners need different criteria:
- Use Day 1's gap %, not today's (which may be near 0)
- Quality score already passed volume confirmation
- Lower pillar threshold (they're pre-qualified)

---

---

### 7. DRCT Validation NoneType Error

**Problem**: DRCT stock showed "awaiting LLM validation" with error `'NoneType' object has no attribute 'get'`

**Root Cause**: Python's `.get('key', {})` returns `None` (not `{}`) when the key exists but its value is `None`. This caused chained `.get()` calls to fail.

**Example**:
```python
# BROKEN: Returns None if llm_analysis key exists but value is None
stock.get('llm_analysis', {}).get('catalyst_strength', 0)

# FIXED: Use 'or {}' to handle None values
(stock.get('llm_analysis') or {}).get('catalyst_strength', 0)
```

**Locations Fixed** in `llm_validator.py`:
| Location | Original | Fixed |
|----------|----------|-------|
| `_calculate_5_pillars:501` | `stock.get('llm_analysis', {})` | `stock.get('llm_analysis') or {}` |
| `_build_runner_section:649-650` | `runner.get('entry_zones', [])` | `runner.get('entry_zones') or []` |
| `_get_system_prompt:671-672` | `self._prompts.get('validation', {})` | `(self._prompts or {}).get('validation') or {}` |
| `_build_user_prompt:678-679` | `self._prompts.get(...)` | `(self._prompts or {}).get(...)` |
| `_get_fallback_result:799-800` | `self._prompts.get('fallback', {})` | `(self._prompts or {}).get('fallback') or {}` |
| `_init_provider:145-146` | `config.get('llm', {})` | `config.get('llm') or {}` |

**Result**: DRCT now validates correctly with `signal: "wait"`, `confidence: 45%`

---

### 8. DEAD Stock BUY Signal Bug (CRITICAL)

**Problem**: LLM validator returned BUY signals for DEAD stocks (YI, OM, KUST all got identical $2.50 entry, 75% confidence)

**Root Causes**:
1. **Example Pollution**: Hardcoded JSON example in prompt was being copied verbatim
2. **Missing Health Status**: Watchlist has `health_status: "DEAD"` but validator ignored it
3. **Hardcoded Exit Signals**: All exit signals returned "OK" instead of real data
4. **Missing Price Trend**: No context about price fading from day high

**Fix**: Two-part solution:

**Part 1: Prompt Template (`config/prompts/validation_prompt.yaml`)**
- Removed hardcoded example JSON (the source of "example pollution")
- Added CRITICAL RULES section:
  - DEAD → signal MUST be "no_trade" with confidence ≤20
  - COOLING → signal "wait" unless GREEN VWAP + stable price
  - is_chasing → signal MUST be "wait"
  - Price down >5% from high → bias toward wait/no_trade
- Added new HEALTH STATUS section with 7 variables

**Part 2: Context Builder (`backend/services/llm_validator.py`)**
- Extract `health_status` and `health_metrics` from watchlist
- Calculate `price_change_from_high` and `price_trend`
- Generate `health_warning` message for DEAD/COOLING/CHASING
- Use real entry/stop zones from runners.json (not arbitrary 5%)
- Derive exit signals from health metrics

**New Context Variables**:
| Variable | Source | Example |
|----------|--------|---------|
| `{health_status}` | watchlist | "DEAD", "COOLING", "HOT" |
| `{health_warning}` | calculated | "CRITICAL: This stock is DEAD..." |
| `{price_trend}` | calculated | "FADING HARD" |
| `{price_change_from_high}` | calculated | -6.4% |
| `{gap_fade_percent}` | health_metrics | 26% |
| `{in_entry_zone}` | health_metrics | "Yes"/"No" |
| `{is_chasing}` | health_metrics | "Yes"/"No" |

**Files Modified**:
- `config/prompts/validation_prompt.yaml` - v1.2.0
- `backend/services/llm_validator.py` - `_build_context()`, `_get_exit_overall()`

---

## Testing Results

### DRCT Validation (after fix)
```json
{
  "signal": "wait",
  "confidence": 45,
  "reasoning": [
    "Price is down more than 5% from day high.",
    "Health status is COOLING, and price is not stable/rising.",
    "No clear VWAP zone in GREEN."
  ],
  "key_concern": "Price decline from day high"
}
```

---

## Key Takeaways (Additional)

### 6. Python `.get()` Default Gotcha
Python's `dict.get('key', default)` only returns `default` if the key is **missing**. If the key exists but has value `None`, it returns `None` - not the default. Always use `dict.get('key') or default` pattern when values could be `None`.

---

### 9. Watchlist Sync Fix (RVYL Missing)

**Problem**: RVYL appeared in trader app (8 stocks) but not in charting app (7 stocks).

**Root Cause**: Data source mismatch:
- **Trader app** returns live `self.watchlist` from memory (8 active stocks)
- **Charting app** was reading `watchlist_state.json` (19 historical stocks, then filtering)

The `watchlist_state.json` is a persistence file containing ALL stocks ever added during the session (for restore purposes), not the currently active watchlist.

**Fix**: Changed charting backend to fetch watchlist directly from trader app API:
- `http://localhost:8080/api/watchlist`
- Ensures perfect sync - both apps show identical data
- Charting app is a companion tool, should mirror what trader shows

**Files Modified**:
- `backend/services/file_watcher.py` - Added `fetch_watchlist_from_trader()`, removed file-based watchlist loading
- `backend/api/routes.py` - `/watchlist` endpoint now refreshes from trader API
- `backend/main.py` - Passes trader API URL from config

**Architecture Change**:
| Data | Source | Reason |
|------|--------|--------|
| Watchlist | Trader API (`/api/watchlist`) | Live sync with trader app |
| Runners | File (`runners.json`) | Stable, no sync issues |

---

### 10. Real-Time Catalyst Boost Integration (v1.43.2 Trader App Data)

**Enhancement**: Integrated trader app's v1.43.2 real-time catalyst re-grading data into charting app's LLM validator.

**Background**: When the trader app detects CRITICAL/HIGH priority streaming headlines, it re-runs LLM analysis and stores the result in `realtime_regrade`. The charting app now leverages this data for smarter validation.

**New Context Variables Added to LLM Validator**:
| Variable | Source | Description |
|----------|--------|-------------|
| `catalyst_boosted` | calculated | True if fresh news boosted catalyst score |
| `catalyst_boost_headline` | realtime_regrade.headline | The breaking news headline |
| `catalyst_boost_minutes_ago` | calculated | How fresh the news is |
| `catalyst_boost_previous_score` | realtime_regrade.previous_score | Score before news |
| `catalyst_boost_new_score` | realtime_regrade.new_score | Score after news |
| `catalyst_boost_score_change` | calculated | Score improvement |
| `catalyst_boost_priority` | realtime_regrade.priority | CRITICAL or HIGH |
| `catalyst_boost_section` | calculated | Formatted section for prompt |

**Prompt Template Changes** (`validation_prompt.yaml` v1.3.0):
- Added `## REAL-TIME CATALYST BOOST` section with `{catalyst_boost_section}`
- Updated CRITICAL RULES: Fresh breaking news adds 10-15 confidence points

**Files Modified**:
- `backend/services/llm_validator.py` - Added `_build_realtime_regrade_context()` method
- `config/prompts/validation_prompt.yaml` - v1.3.0: Added catalyst boost section

**Warrior Trading Alignment**: Breaking news should immediately boost stock priority. Fresh catalyst flow supports bullish bias and higher confidence in validation.

---

### 11. First Pullback Pattern Detection (v1.44.0 Trader App Pattern)

**Enhancement**: Added Ross Cameron's "Morning Panic into Support" pattern detection to charting app's LLM validator, matching the trader app's v1.44.0 implementation.

**Background**: The trader app's MTF Gate now has a First Pullback exception that allows entry when price is BELOW the EMA (normally a rejection). The charting app's LLM validator now independently detects this pattern.

**Pattern Criteria** (all must pass):
1. Time window: First 2 hours (9:30-11:30 AM)
2. Price below VWAP but not crashed (max -15%)
3. Volume still elevated (50x+)
4. Has catalyst (news or strong catalyst score)
5. Recovery signal (2+ consecutive green candles)

**New Methods in `llm_validator.py`**:
- `_build_first_pullback_context()` - Detects pattern and builds context
- `_count_consecutive_green_candles()` - Counts recovery signal candles

**New Context Variables**:
| Variable | Description |
|----------|-------------|
| `first_pullback_detected` | True if pattern detected |
| `first_pullback_vwap_distance` | % below VWAP |
| `first_pullback_volume` | Volume ratio |
| `first_pullback_green_candles` | Consecutive green candles |
| `first_pullback_section` | Formatted section for prompt |

**Prompt Template Changes** (`validation_prompt.yaml` v1.4.0):
- Added `## FIRST PULLBACK PATTERN (v1.44.0)` section
- Updated CRITICAL RULES: First Pullback OVERRIDES "below VWAP" caution

**Example Output When Pattern Detected**:
```
## FIRST PULLBACK PATTERN (v1.44.0)

FIRST PULLBACK PATTERN DETECTED (Morning Panic into Support)
- Price 9.8% below VWAP (oversold washout)
- Volume: 91x (institutional interest confirmed)
- Recovery signal: 3 consecutive green candles
- Catalyst: Yes - fresh news
- Time: 45 minutes since open (within optimal window)

This is Ross Cameron's FIRST PULLBACK setup - entry on the bounce, NOT the chase.
Consider BUY if other conditions support entry.
```

**Warrior Trading Alignment**: First Pullback is a high-probability setup when gappers with catalyst sell off into support. Entry on the bounce captures institutional buying.

---

**Session End**: 2026-01-23
**Backend Status**: Requires restart to apply all fixes
