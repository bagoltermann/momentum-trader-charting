# Session Notes - 2026-01-26

## Status
Performance tuning (8 fixes) + TypeScript cleanup (5 fixes) + LLM pattern detection (1 fix) - 14 total commits, all pushed.

## Session Overview
1. Deep dive analysis of charting app performance issues (slow chart updates, app "not working")
2. Log analysis identified root causes: template variable bug, semaphore starvation, duplicate API calls
3. Planned incremental fix strategy with verification gates and rollback strategy
4. Backend fixes (Commits 1-4): Template bug, semaphore, cached candles, watchlist TTL
5. Frontend fixes (Commits 5-8): Debug logging, single-pass transforms, incremental chart updates, VWAP band optimization
6. TypeScript cleanup (Commits 9-13): Removed 36 pre-existing tsc errors across 5 categories

## Problem Analysis

### Root Causes Identified from `logs/backend.log`
- **580 "Missing template variable" warnings** - Python `str.format()` interpreted `{` and `}` in JSON example as template variables in `validation_prompt.yaml`
- **Semaphore starvation** - 3-connection semaphore saturated by validation API calls, causing chart fetches to wait 5-10s (normal: 0.3-0.5s)
- **Duplicate API requests** - Symbols fetched twice simultaneously
- **Per-request resource creation** - New httpx.Client per watchlist fetch, new axios instance per chart fetch, token file read per API call
- **20+ console.log calls in render path** - UI thread overhead from string formatting
- **Double .map() transforms** - Candle data mapped twice to produce nearly identical arrays
- **Full chart redraw on every refresh** - `setData()` + `fitContent()` called every 30s, resetting zoom/scroll
- **4 separate .map() calls for VWAP bands** - Each band array mapped independently

## Approach
Incremental commits with verification gates, backend first then frontend. Each commit independently revertable. User verified at checkpoints A (after backend) and C (after frontend).

**Known-good rollback hash**: `c8eb240`

## Work Completed

### COMMIT 1: Fix Template Variable Bug (d9be874)
**File**: `config/prompts/validation_prompt.yaml`
- Escaped literal `{` to `{{` and `}` to `}}` in JSON example block
- This was causing LLM to receive raw template text instead of actual stock data

### COMMIT 2: Fix Semaphore Starvation + Token Caching (5fee16f)
**File**: `backend/services/schwab_client.py`
- Increased API semaphore from 3 to 5
- Added 60-second token cache (avoids disk I/O per API call)

### COMMIT 3: Validation Uses Cached Candles (a128cf6)
**Files**: `backend/services/schwab_client.py`, `backend/api/routes.py`
- Added `get_cached_candles()` function to expose server-side candle cache
- Validation endpoint checks cache before making its own API call

### COMMIT 4: Watchlist TTL Caching (9df4352)
**File**: `backend/services/file_watcher.py`
- Added 5-second TTL cache for watchlist data
- Reusable module-level httpx.Client instead of per-request creation
- `get_cached_watchlist(refresh=True)` only fetches if cache is stale

### COMMIT 5: Remove Excessive console.log (c1f48ca)
**Files**: `EnhancedChart.tsx`, `MultiChartGrid.tsx`, `candleDataStore.ts`, `useCandleData.ts`
**New file**: `src/renderer/utils/debugLog.ts`
- Created `debugLog()` utility with `DEBUG_CHARTS = false` flag
- Replaced 20+ `console.log` calls with `debugLog()` across 4 files
- Removed inline JSX `console.log()` from MultiChartGrid render
- `console.error` calls preserved for real errors
- Set `DEBUG_CHARTS = true` in `debugLog.ts` to re-enable

### COMMIT 6: Single-Pass Data Transforms + Reuse Axios (0b66fd0)
**Files**: `candleDataStore.ts`, `useCandleData.ts`
- Replaced double `.map()` with single `for` loop producing both `CandleWithVolume[]` and `Candle[]`
- Created module-level `apiClient = axios.create({ timeout: 15000 })` to reuse connection pool

### COMMIT 7: Incremental Chart Updates (0aa4246)
**File**: `src/renderer/components/charts/EnhancedChart.tsx`
- Added `prevDataRef` to track previous candle count, last timestamp, and symbol
- On auto-refresh (same symbol, count diff <= 1): uses `update()` for last candle only
- On symbol change or substantial data difference: full `setData()` + `fitContent()`
- Prevents zoom/scroll reset during 30s auto-refresh

### COMMIT 8: Combine VWAP Band Mappings (0fe005e)
**File**: `src/renderer/components/charts/EnhancedChart.tsx`
- Added `useMemo` that produces all 4 band arrays in single pass
- Full reload branch uses pre-computed arrays instead of 4 `.map()` calls

## Testing Checklist
- [x] Backend restarts without errors (Checkpoint A)
- [x] Charts load correctly after backend fixes
- [x] Validation works correctly
- [x] App restarts successfully after all commits (Checkpoint B)
- [x] All 8 commits pushed to GitHub
- [ ] Verify incremental chart updates work (no zoom reset on refresh)
- [ ] Verify VWAP bands render correctly
- [ ] DevTools console should show minimal logging

## Files Modified

| File | Description | Commits |
|------|-------------|---------|
| `config/prompts/validation_prompt.yaml` | Escaped JSON braces in template | d9be874 |
| `backend/services/schwab_client.py` | Semaphore 3->5, token cache, expose candle cache | 5fee16f, a128cf6 |
| `backend/api/routes.py` | Validation uses cached candles | a128cf6 |
| `backend/services/file_watcher.py` | Watchlist TTL cache, reuse httpx client | 9df4352 |
| `src/renderer/utils/debugLog.ts` | NEW - Debug logging utility | c1f48ca |
| `src/renderer/components/charts/EnhancedChart.tsx` | debugLog, incremental updates, VWAP bands | c1f48ca, 0aa4246, 0fe005e |
| `src/renderer/components/charts/MultiChartGrid.tsx` | debugLog, removed JSX console.log | c1f48ca |
| `src/renderer/store/candleDataStore.ts` | debugLog, single-pass transform, reuse axios | c1f48ca, 0b66fd0 |
| `src/renderer/hooks/useCandleData.ts` | debugLog, single-pass transform | c1f48ca, 0b66fd0 |

## Commit Summary

| # | Hash | Description |
|---|------|-------------|
| Baseline | 26f81d1 | Previous session's uncommitted changes |
| 1 | d9be874 | Fix template variable bug (escaped JSON braces) |
| 2 | 5fee16f | Semaphore 3->5, token caching |
| 3 | a128cf6 | Validation uses cached candles |
| 4 | 9df4352 | Watchlist TTL caching, reuse httpx client |
| 5 | c1f48ca | Replace console.log with debugLog utility |
| 6 | 0b66fd0 | Single-pass data transforms, reuse axios |
| 7 | 0aa4246 | Incremental chart updates on auto-refresh |
| 8 | 0fe005e | Combine VWAP band mappings into single pass |

## Key Takeaways
- **Methodical approach worked well** - Incremental commits with verification gates prevented cascading issues
- **Log analysis is critical** - The 580 template warnings and 5-10s completion times pointed directly to root causes
- **Backend fixes had the biggest impact** - Semaphore + token caching resolved the "slow/not working" issue
- **Frontend fixes are lower risk** - Debug logging and data transform optimizations are safe quality-of-life improvements
- **Incremental chart updates** (Commit 7) is the riskiest change - monitor for any rendering issues

## Rollback Quick Reference

| Commit | Revert Command | What It Undoes |
|--------|---------------|----------------|
| Any single commit | `git revert HEAD` | Last commit only |
| Last N commits | `git revert HEAD~N..HEAD` | Last N commits |
| Specific commit | `git revert <hash>` | That one commit |
| Nuclear option | `git reset --hard c8eb240` | Everything back to pre-session state |

---

## Phase 2: TypeScript Error Cleanup (36 → 0)

### Status
All 36 pre-existing TypeScript errors fixed across 5 commits, all pushed.

### Overview
After completing the 8 performance commits, `tsc --noEmit` revealed 36 pre-existing TypeScript errors. Used the same incremental commit strategy with verification gates.

**Rollback hash**: `7138cfb` (state before cleanup)

### COMMIT 9: Remove Unused React Imports (79b3bce)
**Files**: 17 files across `src/renderer/`
- `jsx: "react-jsx"` in tsconfig means React doesn't need to be imported
- Removed `import React from 'react'` or removed `React` from named import destructuring
- 36 → 19 errors

### COMMIT 10: Add electronAPI Window Type Declaration (88a4eff)
**New file**: `src/renderer/types/electron.d.ts`
- `window.electronAPI` was typed in `src/main/preload.ts` but tsconfig only includes `src/renderer/`
- Created `.d.ts` file mirroring the preload declaration within renderer scope
- 19 → 15 errors

### COMMIT 11: Fix lightweight-charts Time Type Casts (c7e569b)
**Files**: `CandlestickChart.tsx`, `EnhancedChart.tsx`
- lightweight-charts `setData()` expects `Time` type but our data uses `number` timestamps
- Changed ineffective `as CandlestickData<number>[]` casts to `as any` (matches existing `update()` pattern)
- Removed now-unused `CandlestickData` and `HistogramData` imports from EnhancedChart
- 15 → 9 errors

### COMMIT 12: Remove Unused Variables (6913b74)
**Files**: `ExitSignalDashboard.tsx`, `HistoricalPatternMatch.tsx`, `TimeframeAlignment.tsx`, `indicators.ts`
- ExitSignalDashboard: alias unused `error` prop to `_error` via destructuring
- HistoricalPatternMatch: removed unused `[error, setError] = useState()` (catch block uses console.error)
- TimeframeAlignment: removed unused `firstCandle` variable, aliased `loading`/`error` to `_loading`/`_error`
- indicators.ts: removed unused `priorHigh` and `volumeDecreasing` variables (incomplete pattern detection logic, noted as future improvement)
- 9 → 1 error

### COMMIT 13: Fix LineWidth Type (8d17b6b)
**File**: `EnhancedChart.tsx`
- `strengthWidths` object values returned `number` but `lineWidth` expects `LineWidth` (literal `1|2|3|4`)
- Added `as const` assertion to narrow values to literal types
- 1 → 0 errors

### TypeScript Cleanup Files Modified

| File | Description | Commit |
|------|-------------|--------|
| 17 `.tsx` files | Removed unused React imports | 79b3bce |
| `src/renderer/types/electron.d.ts` | NEW - Window.electronAPI type | 88a4eff |
| `CandlestickChart.tsx` | setData() as any cast | c7e569b |
| `EnhancedChart.tsx` | setData() as any casts, removed unused imports, as const | c7e569b, 8d17b6b |
| `ExitSignalDashboard.tsx` | Alias unused error prop | 6913b74 |
| `HistoricalPatternMatch.tsx` | Remove unused useState | 6913b74 |
| `TimeframeAlignment.tsx` | Remove firstCandle, alias unused props | 6913b74 |
| `indicators.ts` | Remove unused priorHigh, volumeDecreasing | 6913b74 |

### TypeScript Cleanup Commit Summary

| # | Hash | Description | Errors |
|---|------|-------------|--------|
| 9 | 79b3bce | Remove unused React imports (17 files) | 36 → 19 |
| 10 | 88a4eff | Add electronAPI Window type declaration | 19 → 15 |
| 11 | c7e569b | Cast setData() args for lightweight-charts Time type | 15 → 9 |
| 12 | 6913b74 | Remove unused variables (4 files) | 9 → 1 |
| 13 | 8d17b6b | Narrow LineWidth type with as const | 1 → 0 |

### Review Notes
- **`as any` casts (Commit 11)** are tech debt — ideally would use `UTCTimestamp` from lightweight-charts at data creation time, but that's a larger refactor
- **`priorHigh` and `volumeDecreasing` (Commit 12)** were incomplete pattern detection logic in the flag/pennant detector. The comment says "consolidation should be at upper part of prior range" which would need `priorHigh`. Noted for future trading pattern improvement.
- **Underscore prefix for unused props** required destructuring alias syntax (`error: _error`) not just renaming, since prop names must match the interface

---

## Phase 3: LLM Pattern Detection - Catalyst-Response Mismatch (v1.5.0)

### Status
Prompt-only change implementing Idea #1 from `HIGH_VALUE_LLM_PATTERN_DETECTION.md`. Committed and pushed.

### Overview
Reviewed the 5 LLM pattern detection ideas from the momentum-trader docs. Assessed feasibility of each for the charting app's existing LLM validation system. Implemented Idea #1 (Catalyst-Response Mismatch) as a prompt-only change. Documented Ideas #2-#5 as future feature suggestions in `FEATURE_SUGGESTIONS.md`.

### Key Insight
All data variables needed for Idea #1 (`catalyst_strength`, `gap_percent`, `volume_ratio`, `float_formatted`) were already assembled in `llm_validator.py._build_context()` and present in the prompt template. No backend code changes needed - pure prompt engineering.

### COMMIT 14: Catalyst-Response Mismatch Detection (39793a5)
**File**: `config/prompts/validation_prompt.yaml` (v1.4.0 → v1.5.0)
- Added `## CATALYST-RESPONSE ANALYSIS` section between CATALYST and RUNNER STATUS sections
- Evaluates whether price response is proportional to catalyst quality
- Defines 4 mismatch patterns: OVER-REACTION (FOMO), UNDER-REACTION (opportunity), PROPORTIONAL, Float amplification
- Added critical rule: `catalyst_strength <=4 AND gap >20%` → bias toward "wait" unless volume >10x AND VWAP GREEN
- Forces "FOMO over-reaction risk" into `key_concern` field

### Ideas #2-#5 Feasibility Assessment

| Idea | Feasibility | Dependency | Notes |
|------|------------|------------|-------|
| #1 Catalyst-Response | **DONE** (v1.5.0) | None | Prompt-only change |
| #2 Sector Momentum | MEDIUM-HIGH | Trader app `/api/market-context` endpoint | Data exists in MarketContextAnalyzer but not exposed via API |
| #3 Headline Trajectory | MEDIUM | Trader app headline aggregation | NewsAggregator + CatalystClassifier exist but no per-symbol trajectory |
| #4 Historical Analogs | HIGH | Backend similarity function | trade_outcomes.jsonl exists, need vector similarity search |
| #5 Float/Catalyst/Time | MEDIUM | 4+ weeks signal_events data | Data collecting via v1.45.0, needs maturity |

### Feature Suggestions Documentation
Updated `FEATURE_SUGGESTIONS.md` with:
- Phase 5 (LLM Pattern Detection) section in Table of Contents
- v1.5.0 Catalyst-Response Mismatch in "Recently Implemented" section
- Full write-ups for Ideas #2-#5 with current state, implementation paths, and priority table

### Files Modified

| File | Description | Commit |
|------|-------------|--------|
| `config/prompts/validation_prompt.yaml` | v1.5.0 - Catalyst-Response Analysis + FOMO rule | 39793a5 |
| `FEATURE_SUGGESTIONS.md` | Phase 5 ideas #2-#5 documentation | (docs update) |

## Next Steps
- Test incremental chart updates during live trading (verify no zoom reset on 30s refresh)
- Test VWAP bands render correctly with pre-computed arrays
- Monitor DevTools console for clean logging output
- Test catalyst-response mismatch detection during live validation (verify LLM references FOMO/under-reaction in reasoning)
- Consider further optimization: WebSocket for real-time candle updates instead of polling
- Consider replacing `as any` casts with proper `UTCTimestamp` typing at data creation
- Consider completing flag/pennant pattern detection (`priorHigh` check, `volumeDecreasing` check)
- Implement Idea #2 (Sector Momentum) when trader app adds `/api/market-context` endpoint
