# Session Notes - 2026-01-26

## Status
Performance tuning session - 8 targeted fixes across backend and frontend, all committed and pushed.

## Session Overview
1. Deep dive analysis of charting app performance issues (slow chart updates, app "not working")
2. Log analysis identified root causes: template variable bug, semaphore starvation, duplicate API calls
3. Planned incremental fix strategy with verification gates and rollback strategy
4. Backend fixes (Commits 1-4): Template bug, semaphore, cached candles, watchlist TTL
5. Frontend fixes (Commits 5-8): Debug logging, single-pass transforms, incremental chart updates, VWAP band optimization

## Problem Analysis

### Root Causes Identified from `logs/backend.log`
- **580 "Missing template variable" warnings** - Python `str.format()` interpreted `{` and `}` in JSON example as template variables in `validation_prompt.yaml`
- **Semaphore starvation** - 3-connection semaphore saturated by validation API calls, causing chart fetches to wait 5-10s (normal: 0.3-0.5s)
- **Duplicate API requests** - Symbols fetched twice simultaneously
- **Per-request resource creation** - New httpx.Client per watchlist fetch, new axios instance per chart fetch, token file read per API call
- **20+ console.log calls in render path** - UI thread overhead from string formatting
- **Double .map() transforms** - Candle data mapped twice to produce nearly identical arrays
- **Full chart redraw on every refresh** - `setData()` + `fitContent()` called every 30s, resetting zoom/scroll
- **4 separate .map() calls for VWAP bands** - Each band array mapped independently

## Approach
Incremental commits with verification gates, backend first then frontend. Each commit independently revertable. User verified at checkpoints A (after backend) and C (after frontend).

**Known-good rollback hash**: `c8eb240`

## Work Completed

### COMMIT 1: Fix Template Variable Bug (d9be874)
**File**: `config/prompts/validation_prompt.yaml`
- Escaped literal `{` to `{{` and `}` to `}}` in JSON example block
- This was causing LLM to receive raw template text instead of actual stock data

### COMMIT 2: Fix Semaphore Starvation + Token Caching (5fee16f)
**File**: `backend/services/schwab_client.py`
- Increased API semaphore from 3 to 5
- Added 60-second token cache (avoids disk I/O per API call)

### COMMIT 3: Validation Uses Cached Candles (a128cf6)
**Files**: `backend/services/schwab_client.py`, `backend/api/routes.py`
- Added `get_cached_candles()` function to expose server-side candle cache
- Validation endpoint checks cache before making its own API call

### COMMIT 4: Watchlist TTL Caching (9df4352)
**File**: `backend/services/file_watcher.py`
- Added 5-second TTL cache for watchlist data
- Reusable module-level httpx.Client instead of per-request creation
- `get_cached_watchlist(refresh=True)` only fetches if cache is stale

### COMMIT 5: Remove Excessive console.log (c1f48ca)
**Files**: `EnhancedChart.tsx`, `MultiChartGrid.tsx`, `candleDataStore.ts`, `useCandleData.ts`
**New file**: `src/renderer/utils/debugLog.ts`
- Created `debugLog()` utility with `DEBUG_CHARTS = false` flag
- Replaced 20+ `console.log` calls with `debugLog()` across 4 files
- Removed inline JSX `console.log()` from MultiChartGrid render
- `console.error` calls preserved for real errors
- Set `DEBUG_CHARTS = true` in `debugLog.ts` to re-enable

### COMMIT 6: Single-Pass Data Transforms + Reuse Axios (0b66fd0)
**Files**: `candleDataStore.ts`, `useCandleData.ts`
- Replaced double `.map()` with single `for` loop producing both `CandleWithVolume[]` and `Candle[]`
- Created module-level `apiClient = axios.create({ timeout: 15000 })` to reuse connection pool

### COMMIT 7: Incremental Chart Updates (0aa4246)
**File**: `src/renderer/components/charts/EnhancedChart.tsx`
- Added `prevDataRef` to track previous candle count, last timestamp, and symbol
- On auto-refresh (same symbol, count diff <= 1): uses `update()` for last candle only
- On symbol change or substantial data difference: full `setData()` + `fitContent()`
- Prevents zoom/scroll reset during 30s auto-refresh

### COMMIT 8: Combine VWAP Band Mappings (0fe005e)
**File**: `src/renderer/components/charts/EnhancedChart.tsx`
- Added `useMemo` that produces all 4 band arrays in single pass
- Full reload branch uses pre-computed arrays instead of 4 `.map()` calls

## Testing Checklist
- [x] Backend restarts without errors (Checkpoint A)
- [x] Charts load correctly after backend fixes
- [x] Validation works correctly
- [x] App restarts successfully after all commits (Checkpoint B)
- [x] All 8 commits pushed to GitHub
- [ ] Verify incremental chart updates work (no zoom reset on refresh)
- [ ] Verify VWAP bands render correctly
- [ ] DevTools console should show minimal logging

## Files Modified

| File | Description | Commits |
|------|-------------|---------|
| `config/prompts/validation_prompt.yaml` | Escaped JSON braces in template | d9be874 |
| `backend/services/schwab_client.py` | Semaphore 3->5, token cache, expose candle cache | 5fee16f, a128cf6 |
| `backend/api/routes.py` | Validation uses cached candles | a128cf6 |
| `backend/services/file_watcher.py` | Watchlist TTL cache, reuse httpx client | 9df4352 |
| `src/renderer/utils/debugLog.ts` | NEW - Debug logging utility | c1f48ca |
| `src/renderer/components/charts/EnhancedChart.tsx` | debugLog, incremental updates, VWAP bands | c1f48ca, 0aa4246, 0fe005e |
| `src/renderer/components/charts/MultiChartGrid.tsx` | debugLog, removed JSX console.log | c1f48ca |
| `src/renderer/store/candleDataStore.ts` | debugLog, single-pass transform, reuse axios | c1f48ca, 0b66fd0 |
| `src/renderer/hooks/useCandleData.ts` | debugLog, single-pass transform | c1f48ca, 0b66fd0 |

## Commit Summary

| # | Hash | Description |
|---|------|-------------|
| Baseline | 26f81d1 | Previous session's uncommitted changes |
| 1 | d9be874 | Fix template variable bug (escaped JSON braces) |
| 2 | 5fee16f | Semaphore 3->5, token caching |
| 3 | a128cf6 | Validation uses cached candles |
| 4 | 9df4352 | Watchlist TTL caching, reuse httpx client |
| 5 | c1f48ca | Replace console.log with debugLog utility |
| 6 | 0b66fd0 | Single-pass data transforms, reuse axios |
| 7 | 0aa4246 | Incremental chart updates on auto-refresh |
| 8 | 0fe005e | Combine VWAP band mappings into single pass |

## Key Takeaways
- **Methodical approach worked well** - Incremental commits with verification gates prevented cascading issues
- **Log analysis is critical** - The 580 template warnings and 5-10s completion times pointed directly to root causes
- **Backend fixes had the biggest impact** - Semaphore + token caching resolved the "slow/not working" issue
- **Frontend fixes are lower risk** - Debug logging and data transform optimizations are safe quality-of-life improvements
- **Incremental chart updates** (Commit 7) is the riskiest change - monitor for any rendering issues

## Rollback Quick Reference

| Commit | Revert Command | What It Undoes |
|--------|---------------|----------------|
| Any single commit | `git revert HEAD` | Last commit only |
| Last N commits | `git revert HEAD~N..HEAD` | Last N commits |
| Specific commit | `git revert <hash>` | That one commit |
| Nuclear option | `git reset --hard c8eb240` | Everything back to pre-session state |

## Next Steps
- Test incremental chart updates during live trading (verify no zoom reset on 30s refresh)
- Test VWAP bands render correctly with pre-computed arrays
- Monitor DevTools console for clean logging output
- Consider further optimization: WebSocket for real-time candle updates instead of polling
